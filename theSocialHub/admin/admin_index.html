<?php
/*******************************************************************************
 Author: Brandon Miethe
 Date: 02/05/2021
 
  Modification Log:
 
 * Created inital doc
 
  
 ******************************************************************************/
    
        $dsn = 'mysql:host=localhost;dbname=shContact';
        $username = 'sh_user';
        $password = 'Pa$$w0rd';

        try {
            $db = new PDO($dsn, $username, $password);
        } catch (PDOException $e) {
            $error_message = $e->getMessage();
            echo "Database error: " . $error_message;
            exit();
        }

        $action = filter_input(INPUT_POST, 'action');
        if($action == NULL){
            $action = 'list_visitors';
        }
        
        if($action == 'list_visitors'){
            //Read employee data
            $employeeID = filter_input(INPUT_GET, 'employeeID', FILTER_VALIDATE_INT);
            if($employeeID == NULL || $employeeID == FALSE){
                $employeeID = 1;
            }
            try {
                // Add visitor info to db
            $query = 'SELECT * FROM employee ORDER BY employeeID';
            $statement = $db->prepare($query);
            $statement->execute();
            $employees = $statement;
            
            $query2 = 'SELECT * FROM visitor WHERE visitor.employeeID = :employeeID ORDER BY visit_date;';
            $statement2 = $db->prepare($query2);
            $statement2->bindValue(':employeeID', $employeeID);
            $statement2->execute();
            $visitors = $statement2;
            } catch (PDOException $ex) {
                echo 'Error: '.$ex->getMessage();
            }
        }else if($action == 'delete_visitor'){
            //Delete the visit record
            $visitorID = filter_input(INPUT_POST, 'visitorID', FILTER_VALIDATE_INT);
            
            try {
                
            $query = 'DELETE FROM visitor WHERE visitorID = :visitorID;';
            $statement = $db->prepare($query);
            $statement->bindValue(':visitorID',$visitorID);
            $statement->execute();
            $statement->closeCursor();
            header("Location: admin_index.php");
        } catch (PDOException $ex) {
                echo 'Error on delete: '.$ex->getMessage();
            }
        }
        
    
?>

<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <title>The Social Hub</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="../css/normalize.css">
        <link rel="stylesheet" type="text/css" href="../css/styles.css">
        <script src="js/nav.js"></script>
    </head>
    <body>
        <header>
            <div class="topnav" id="myTopnav">
                <a href="../index.html" class="active">TheSocialHub</a>
                <a href="#about">About</a>
                <a href="#admin">Admin</a>
                <a href="#contact">Contact</a>
                <a href="javascript:void(0);" class="icon" onclick="myFunction()">
                  <i class="fa fa-bars"></i>
                </a>
              </div>
            
            <h1>ADMIN PANEL</h1>
        </header>
        <aside>
            <!-- display a list of categories -->
            <h2>Select an employee to view messages</h2>
            <nav>
                <ul style="list-style-type: none">
                <?php foreach ($employees as $employee) : ?>
                <!--Add a . before ? if it's broken--><li><a href="?employeeID=<?php echo $employee['employeeID']; ?>">
                        <?php echo $employee['first_name'] . $employee['last_name']; ?>
                    </a>
                </li>
                <?php endforeach; ?>
            </ul>
            </nav>          
        </aside>
        
        <section id='admin'>
            <!-- display a table of products -->
            <h2>Selected Employee's Messages</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Date</th>
                    <th>Message</th>
                </tr>

                <?php foreach ($visitors as $visitor) : ?>
                <tr>
                    <td><?php echo $visitor['visitor_name']; ?></td>
                    <td><?php echo $visitor['visitor_email']; ?></td>
                    <td><?php echo $visitor['visit_date']; ?></td>
                    <td><?php echo $visitor['visitor_msg']; ?></td>
                    <td><form action="admin_index.php" method="post">
                            <input type="hidden" name="action" value="delete_visitor">
                            <input type="hidden" name="visitorID" value="<?php echo $visitor['visitorID'];?>">
                            <input type="submit" value="Delete">
                        </form>
                    </td>
                </tr>
                <?php endforeach; ?>
            </table>
        </section>
    </body>
</html>


